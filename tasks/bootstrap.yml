---
- name: bootstrap | Check if initial install
  no_log: true
  register: init_run
  when: not skip_setup
  ansible.builtin.stat:
    path: init_run_path

- name: bootstrap | Set skip_setup to true if initial run
  when: not skip_setup
  ansible.builtin.set_fact:
    skip_setup: "{{ init_run.stat.exists }}"

- name: bootstrap | Install collections and roles together
  when: not skip_setup
  community.general.ansible_galaxy_install:
    type: both
    requirements_file: requirements.yml

- name: bootstrap | Install core packages
  when: not skip_setup
  ansible.builtin.package:
    state: latest
    name:
      - git
      - stow

- name: bootstrap | Ensure dotfiles are present
  when: not skip_setup
  register: dotfiles_home
  ansible.builtin.stat:
    path: "{{ DOTFILES_HOME }}"

- name: bootstrap | Make sure dotfiles are present
  when: (not skip_setup) and (not dotfiles_home.stat.exists)
  ansible.builtin.git:
    repo: https://github.com/{{ GIT.USER }}/dotfiles.git
    dest: ~/.dotfiles
    version: HEAD
