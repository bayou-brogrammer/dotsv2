---
- name: Check if initial install
  register: init_run
  stat:
    path: "{{ DOTFILES_HOME }}/.initial_run"

- name: Set skip to true if initial run
  set_fact:
    skip: "{{ init_run.stat.exists }}"

- name: Create initial run file
  when: init_run.stat.exists == false
  file:
    state: touch
    path: "{{ DOTFILES_HOME }}/.initial_run"

- name: Install collections and roles together
  when: skip == false
  community.general.ansible_galaxy_install:
    type: both
    requirements_file: requirements.yml

- name: Install core packages
  when: skip == false
  ansible.builtin.package:
    state: latest
    name:
      - git
      - stow

- name: Ensure dotfiles are present
  when: skip == false
  register: dotfiles_home
  stat:
    path: "{{ DOTFILES_HOME }}"

- name: Make sure dotfiles are present
  when:  (skip == false) and (dotfiles_home.stat.exists == False)
  git:
    repo: https://github.com/{{ GIT.USER }}/dotfiles.git
    dest: ~/.dotfiles