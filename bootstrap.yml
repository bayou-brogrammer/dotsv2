---
- name: Andromeda Playbook
  hosts: cosmos
  connection: localhost,

  vars:
    init_run_path: "{{ DOTFILES_HOME }}/.inital-run"
    update_system: '{{ lookup("env", "ANDROMEDA_UPDATE") }}'
    skip_setup: '{{ lookup("env", "ANDROMEDA_SKIP_SETUP") }}'
    ansible_password: '{{ lookup("env", "ANSIBLE_PASSWORD") }}'

  tasks:
    - name: Display all variables/facts known for a host
      no_log: "{{ ansible_verbosity != 4 }}"
      ansible.builtin.debug:
        var: hostvars[inventory_hostname]
        verbosity: 4

    - name: Ensure Environment and system is ready for ansible
      ansible.builtin.include_tasks: "{{ item }}"
      loop:
        - tasks/env.yml
        - tasks/bootstrap.yml

    - name: System Setup
      tags: system
      ansible.builtin.import_role:
        name: system

    - name: Create .inital-run file
      no_log: true
      when: (not skip_setup) and (not init_run.stat.exists)
      ansible.builtin.file:
        state: touch
        mode: "0644"
        path: init_run_path
