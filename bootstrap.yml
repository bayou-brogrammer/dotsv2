---
- name: Bootstrap development environment
  hosts: cosmos
  connection: local
  tasks:
    - name: Ensure Nix is installed
      ignore_errors: true
      register: nix_installed
      ansible.builtin.shell: nix --version

    - name: Install Nix
      when: nix_installed.rc != 0
      ansible.builtin.shell: curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install --no-confirm

    - name: Install core packages using Pacman
      become: true
      community.general.pacman:
        state: latest
        update_cache: yes
        name: "{{ item }}"
      loop:
        - git
        - stow

    - name: Install collections and roles together
      community.general.ansible_galaxy_install:
        type: both
        requirements_file: requirements.yml

    - name: Ensure dotfiles are present
      stat:
        path: "{{ DOTFILES_HOME }}"
      register: dotfiles_home

    - name: Make sure dotfiles are present
      when: dotfiles_home.stat.exists == False
      git:
        repo: https://github.com/{{ GIT.USER }}/dotfiles.git
        dest: ~/.dotfiles

    - name: System
      tags: system
      import_role:
        name: system